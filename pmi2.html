<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>Mallorca Busy Map (MVP)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+gXk3RyZkS1V9RrutG2OpWkS0ZbP0u8="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --text: #e8eefc;
      --muted: #9fb0d6;
      --accent: #7aa2ff;
      --accent-2: #31c48d;
      --border: #22314d;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }

    header {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(180deg, #0d1628 0%, #0b1220 100%);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 5000;
    }
    .brand { font-weight: 700; letter-spacing: 0.2px; }
    .status {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      padding: 8px 12px; background: var(--panel); border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .status .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--accent-2); box-shadow: 0 0 12px var(--accent-2); }
    .muted { color: var(--muted); }

    .controls {
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
      padding: 8px 12px; background: var(--panel); border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    button, .btn {
      appearance: none; border: 1px solid var(--border); color: var(--text); background: #0f1830;
      padding: 8px 12px; border-radius: 12px; cursor: pointer; transition: 0.2s transform, 0.2s background, 0.2s border-color;
    }
    button:hover, .btn:hover { background: #142041; transform: translateY(-1px); }
    button.primary { background: #1a2a52; border-color: #2a3c66; }
    button.primary:hover { background: #203364; }
    .btn-link { color: var(--accent); text-decoration: none; }

    #map { width: 100%; height: 100%; }

    .panel {
      position: absolute; z-index: 4000; right: 16px; bottom: 16px; left: 16px; max-width: 680px; margin-left: auto;
      background: rgba(13,22,40,0.92); backdrop-filter: blur(8px); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 12px;
    }
    .row { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; }
    .label { font-size: 12px; color: var(--muted); }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
      height: 28px;
      background: transparent;
    }

    .badger {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px;
      background: #0e1933; border: 1px solid var(--border); color: var(--muted); font-size: 12px;
    }

    @media (max-width: 720px) {
      header { grid-template-columns: 1fr; gap: 8px; }
      .status, .controls { width: 100%; }
      .panel { left: 8px; right: 8px; }
      .row { grid-template-columns: 1fr; gap: 6px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand">üå∂Ô∏è Mallorca Busy Map ‚Äî MVP</div>

      <div class="status" id="status">
        <span class="dot"></span>
        <span id="timeLabel">Loading time‚Ä¶</span>
        <span class="badger" id="modeBadge">NOW</span>
      </div>

      <div class="controls">
        <button class="primary" id="nowBtn" title="Jump to current time">Now</button>
        <button id="shareBtn" title="Copy a sharable link">Share</button>
        <a class="btn btn-link" href="https://www.openstreetmap.org/copyright" target="_blank" rel="noreferrer">¬© OpenStreetMap</a>
      </div>
    </header>

    <div id="map"></div>

    <div class="panel">
      <div class="row">
        <div>
          <div class="label">Time Window</div>
          <div id="rangeCaption" class="muted">Last 24 hours</div>
        </div>
        <div class="badger" id="pointCount">0 points</div>
        <div class="badger" id="busynessAvg">‚Äì avg</div>
      </div>
      <input id="timeRange" type="range" min="0" max="23" step="1" value="0" />
      <div class="label muted">Drag the slider ‚Üí 0 = now, 23 = 23 hours ago</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Leaflet.heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.47.10/dist/umd/supabase.js"></script>

  <script>
    // =========================
    // REQUIRED: EDIT THESE TWO
    // =========================
    // Replace with your Supabase project values (Project Settings ‚Üí API)
    const SUPABASE_URL = "https://rsbxesqwijscicakxjkk.supabase.co";  // <-- change this
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzYnhlc3F3aWpzY2ljYWt4amtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NTA3ODIsImV4cCI6MjA3MTAyNjc4Mn0.cPrMh42Khl21MsXYl4IOWViYZftsVjXi52Df4VhjWK8";             // <-- change this
    // Make sure your RLS policies allow SELECT on both tables for anon.

    // Map center: Palma de Mallorca
    const INITIAL_VIEW = { lat: 39.5696, lng: 2.6502, zoom: 13 };

    // Create Supabase client
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Map + heat layer
    const map = L.map("map", {
      zoomControl: true,
      minZoom: 3,
      worldCopyJump: true,
      attributionControl: false
    }).setView([INITIAL_VIEW.lat, INITIAL_VIEW.lng], INITIAL_VIEW.zoom);

    L.control.attribution({ position: "bottomleft" }).addTo(map);

    const tiles = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://www.carto.com/">CARTO</a>',
        subdomains: "abcd",
        maxZoom: 20
      }
    ).addTo(map);

    const heat = L.heatLayer([], {
      radius: 28,
      blur: 18,
      maxZoom: 19,
      minOpacity: 0.25
    }).addTo(map);

    // UI elements
    const timeRange = document.getElementById("timeRange");
    const timeLabel = document.getElementById("timeLabel");
    const rangeCaption = document.getElementById("rangeCaption");
    const nowBtn = document.getElementById("nowBtn");
    const shareBtn = document.getElementById("shareBtn");
    const modeBadge = document.getElementById("modeBadge");
    const pointCount = document.getElementById("pointCount");
    const busynessAvg = document.getElementById("busynessAvg");

    // Helpers
    function pad2(n){ return (n<10?"0":"") + n; }

    // Compute target timestamp based on slider (0 = now, 23 = 23h ago).
    function getTargetDate() {
      const urlTs = new URLSearchParams(location.search).get("ts");
      let base = urlTs ? new Date(urlTs) : new Date();
      // Slider is "hours ago"
      const hoursAgo = Number(timeRange.value || 0);
      const target = new Date(base.getTime() - hoursAgo * 3600 * 1000);
      return target;
    }

    // Map JS Date => day_of_week (0=Mon‚Ä¶6=Sun) and hour (0‚Äì23), Europe/Madrid local time.
    function toDowHour(date) {
      // Force Europe/Madrid by using Intl and then parse; simple approach for MVP.
      const fmt = new Intl.DateTimeFormat("en-GB", {
        timeZone: "Europe/Madrid",
        weekday: "short",
        hour: "2-digit",
        hour12: false
      });
      const parts = fmt.formatToParts(date);
      const w = parts.find(p => p.type === "weekday").value; // Mon, Tue, ...
      const h = Number(parts.find(p => p.type === "hour").value);
      const map = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
      return { day: map[w], hour: h, label: `${w} ${pad2(h)}:00` };
    }

    function updateStatusText(target, labelText) {
      const live = Number(timeRange.value) === 0 && !new URLSearchParams(location.search).get("ts");
      modeBadge.textContent = live ? "NOW" : "HISTORIC";
      timeLabel.textContent = labelText + (live ? " (live look)" : " (time travel)");
      rangeCaption.textContent = `Showing: ${labelText} (Europe/Madrid)`;
    }

    // Fetch heat points from Supabase for a given day/hour.
    async function fetchHeatPoints(day, hour) {
      // We require the related business coordinates; use inner join.
      // Ensure FK exists: activity_patterns.business_id -> businesses.id
      const sel = "typical_busyness,hour,day_of_week,businesses!inner(latitude,longitude)";
      const { data, error } = await sb
        .from("activity_patterns")
        .select(sel)
        .eq("day_of_week", day)
        .eq("hour", hour);

      if (error) {
        console.error(error);
        return [];
      }

      // Convert to [lat, lng, intensity] for Leaflet.heat
      const points = data
        .filter(row => row.businesses && row.businesses.latitude && row.businesses.longitude)
        .map(row => {
          const lat = Number(row.businesses.latitude);
          const lng = Number(row.businesses.longitude);
          let intensity = Number(row.typical_busyness || 0) / 100;
          if (!isFinite(intensity)) intensity = 0;
          return [lat, lng, intensity];
        });

      return points;
    }

    // Render loop
    let autoTimer = null;

    async function renderHeat() {
      const target = getTargetDate();
      const { day, hour, label } = toDowHour(target);
      updateStatusText(target, label);

      const points = await fetchHeatPoints(day, hour);
      heat.setLatLngs(points);

      // Update small stats
      pointCount.textContent = `${points.length} points`;
      if (points.length) {
        const avg = (points.reduce((a,p)=>a+(p[2]*100),0) / points.length).toFixed(0);
        busynessAvg.textContent = `${avg}% avg`;
      } else {
        busynessAvg.textContent = "‚Äì avg";
      }
    }

    function scheduleAutoRefresh() {
      if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      // Only auto-refresh when slider = 0 and no explicit ts param (live look)
      const live = Number(timeRange.value) === 0 && !new URLSearchParams(location.search).get("ts");
      if (live) {
        autoTimer = setInterval(renderHeat, 60 * 1000); // refresh every 60s
      }
    }

    // Events
    timeRange.addEventListener("input", () => {
      renderHeat();
      scheduleAutoRefresh();
      // Update URL (no reload) with offset param for share
      const p = new URLSearchParams(location.search);
      p.delete("ts"); // offset-based view; ts is a fixed timestamp view
      p.set("offset", String(Number(timeRange.value)));
      history.replaceState(null, "", `${location.pathname}?${p.toString()}`);
    });

    nowBtn.addEventListener("click", () => {
      const p = new URLSearchParams(location.search);
      p.delete("ts"); // clear fixed timestamp
      p.delete("offset");
      history.replaceState(null, "", location.pathname);
      timeRange.value = "0";
      renderHeat();
      scheduleAutoRefresh();
    });

    shareBtn.addEventListener("click", async () => {
      // Share a fixed timestamp view (so recipients see exactly what you see)
      const target = getTargetDate();
      const ts = target.toISOString();
      const url = new URL(location.href);
      url.searchParams.delete("offset");
      url.searchParams.set("ts", ts);
      try {
        await navigator.clipboard.writeText(url.toString());
        shareBtn.textContent = "Copied ‚úî";
        setTimeout(()=> shareBtn.textContent = "Share", 1400);
      } catch {
        alert(url.toString());
      }
    });

    // On load: respect URL params (?ts=ISO or ?offset=H)
    (async function init() {
      // Center on Palma
      map.setView([INITIAL_VIEW.lat, INITIAL_VIEW.lng], INITIAL_VIEW.zoom);

      // If offset param exists, set slider
      const sp = new URLSearchParams(location.search);
      const offset = sp.get("offset");
      if (offset !== null) {
        timeRange.value = String(Math.min(23, Math.max(0, Number(offset)||0)));
      } else if (sp.get("ts")) {
        // Fixed timestamp view ‚Üí set slider to 0 (we compute exact hour from ts)
        timeRange.value = "0";
      } else {
        timeRange.value = "0"; // live by default
      }

      await renderHeat();
      scheduleAutoRefresh();
    })();
  </script>
</body>
</html>
